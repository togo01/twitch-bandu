<!DOCTYPE html>
<html lang='zh-tw' style='overflow: hidden;' xml:lang='zh-tw' xmlns:fb='http://www.facebook.com/2008/fbml'
    xmlns:og='http://opengraphprotocol.org/schema/' xmlns='http://www.w3.org/1999/xhtml'>

<head>
    <meta charset="utf-8">
    <title>twitch chat with tts</title>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css">
    <link rel="shortcut icon" href="#" />
    <link rel="bookmark" href="#" />
    <link href="https://fonts.googleapis.com/css?family=Germania+One|Baloo+Thambi|Press+Start+2P" rel="stylesheet">
    <style type="text/css">
        ::-webkit-scrollbar {
            background-color: rgb(25, 25, 25);
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgb(50, 50, 50);
        }

        .scroll {
            position: relative;
            overflow: hidden;
        }

        .option {
            color: #999;
            line-height: 30px !important;
            width: -moz-calc(100% - 20px);
            width: -webkit-calc(100% - 20px);
            width: calc(100% - 20px);
            background-color: rgb(30, 30, 30);
            border-bottom: 1px solid rgb(0, 0, 0) !important;
            padding-left: 10px !important;
            padding-right: 10px !important;
            padding-top: 3px !important;
            padding-bottom: 2px !important;
            box-shadow: 0px 1px 0px rgba(255, 255, 255, 0.04) inset !important;
        }

        .switch-label {
            position: relative;
            z-index: 2;
            float: left;
            width: 60px;
            line-height: 26px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.35);
            text-align: center;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.45);
            cursor: pointer;
            border-radius: 5px;
            margin: 0px
        }

        #msellist select {
            padding: 0px;
            margin: 0;
            background-color: rgb(35, 35, 35);
            color: #D3D3D3;
            height: 25px;
            vertical-align: top;
            border: 0
        }

        .option textarea {
            padding: 2px;
            margin: 0;
        }

        .option button {
            min-height: 2em
        }

        .closebutton:hover {
            cursor: pointer;
        }

        .ircline {
            padding: 2px;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 24px !important;
            line-height: 26px !important;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            letter-spacing: 1px;
            font-variant: normal;
            font-weight: bold;
            font-style: normal;
            color: #fff;
        }

        ruby {
            font-family: 'Helvetica Neue', 'Germania One', Helvetica, Arial, sans-serif;
        }

        rt {
            font-family: 'Press Start 2P', cursive;
        }

        .message {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif, Meiryo, "微軟正黑體", Microsoft JhengHei;
            text-shadow: #000 0px 0px 1px, #000 0px 0px 1px, #000 0px 0px 1px, #000 0px 0px 1px, #000 0px 0px 1px, #000 0px 0px 1px;
        }

        #chat_box {
            height: calc(100% - 13px);
            overflow: hidden;
            position: absolute;
        }

        #maudio {
            position: relative;
            left: 10px;
            top: 4px;
            width: 670px;
        }

        audio::-webkit-media-controls-panel {
            background-color: rgb(35, 35, 35);
            color: rgb(211, 211, 211);
        }

        audio::-webkit-media-controls-mute-button,
        audio::-webkit-media-controls-play-button {
            color: rgb(211, 211, 211);
        }

        img {
            margin: 0px;
            padding: 0px;
            vertical-align: middle;
            height: 25px;
        }

        a {
            color: #AAAAAA;
        }

        @keyframes scrollclip {
            from {
                clip-path: polygon(0% 0%, 1% 0%, 1% 100%, 0% 100%);
            }

            to {
                clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);
            }
        }
    </style>
    <script src="index.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>

    <script type="text/javascript">
        //https://ttv-api.s3.amazonaws.com/twitch.min.js

        var audioQueue = [];
        var audioIndex = {};
        var audioList = [];
        var audioLibrary = {};
        var audioLibraryBuild = 0;

        var transcache = {};
        var ttscache = {};
        var ttsremotecache = [];
        var ttsremotebuild = 0;

        var filters = [];
        var filter_build = 0;

        var users = { "global": { lastMessage: "", lastMessageAt: 0, hasSameMessageCount: 0 } };
        var valid_users = {};
        var valid_users_build = 0;

        var bot = null;
        var username = 'justinfan12345';
        var oauth = 'blah';

        var msgarray = new Array();
        var selist = [];
        var cd = true;
        var channel = "";
        var engine = "togo";
        var itriconfig = "TW_SPK_AKoan,0,0,0,5";
        var volume = 0.6;
        var banlist = "nightbot";
        var se = "on";
        var cdsec = "25";

        var audio;

        function checkAudioListVersion() {
            $.ajax({
                type: "get",
                url: "version.json",
                dataType: "json",
                cache: false,
                success: function (json) {
                    if (json.audio_library != audioLibraryBuild) {
                        reloadAudioList();
                    }
                    if (json.ttscache != ttsremotebuild) {
                        reloadTTSRemoteCache();
                    }
                    if (json.filter != filter_build) {
                        reloadFilter();
                    }
                    if (json.users != valid_users_build) {
                        reloadUsers();
                    }
                }
            })
        }

        function reloadAudioList(firstLoad = false) {
            $.ajax({
                type: "get",
                url: "audio.json",
                dataType: "json",
                cache: false,
                success: function (json) {
                    audioIndex = json.index;
                    audioList = json.audio;
                    audioLibrary = json.library;
                    audioLibraryBuild = json.build;
                    //if (!firstLoad) AddMessageQueue(ProcessMessageToQueue("滾滾別害怕，已為您重新載入了 " + audioList.length + " 個指令。"));
                }
            });
        }

        function reloadTTSRemoteCache() {
            $.ajax({
                type: "get",
                url: "ttscache.json",
                dataType: "json",
                cache: false,
                success: function (json) {
                    ttsremotecache = json.ttscache;
                    ttsremotebuild = json.build;
                }
            });
        }

        function reloadFilter(firstLoad = false) {
            $.ajax({
                type: "get",
                url: "filter.json",
                dataType: "json",
                cache: false,
                success: function (json) {
                    filters = json.filters;
                    filter_build = json.build;
                    for(i in filters) {
                        var flags = filters[i].regex.replace(/.*\/([gimy]*)$/, '$1');
                        var pattern = filters[i].regex.replace(new RegExp('^/(.*?)/'+flags+'$'), '$1');
                        var regex = new RegExp(pattern, flags);
                        filters[i].regex = regex;

                        if (filters[i].match != "") { 
                            flags = filters[i].match.replace(/.*\/([gimy]*)$/, '$1');
                            pattern = filters[i].match.replace(new RegExp('^/(.*?)/'+flags+'$'), '$1');
                            regex = new RegExp(pattern, flags);
                            filters[i].match = regex;
                        }
                    }
                    //if (!firstLoad) AddMessageQueue(ProcessMessageToQueue("已重新載入棒讀文字過濾規則。"));
                }
            });
        }

        function reloadUsers() {
            $.ajax({
                type: "get",
                url: "users.json",
                dataType: "json",
                cache: false,
                success: function (json) {
                    valid_users = json.users;
                    valid_users_build = json.build;
                }
            });
        }

        function getAudioFromLibrary(msg) {
            if (audioList.indexOf(msg) == -1)
                return null;
            if (!(msg in audioLibrary))
                return msg + ".mp3";
            var audios = audioLibrary[msg];
            return audios[Math.floor(Math.random() * audios.length)];
        }

        function TriggerTTLPlay() {
            if (audio.src != "" && !audio.ended) return;
            if (engine == "google") {
                if (msgarray.length == 0) return;
                var url = msgarray.shift();
                audio.src = url;
                audio.autoplay = true;
                audio.load();
            } else if (engine == "togo") {
                if (audioQueue.length == 0) return;
                var src = audioQueue.shift();
                audio.src = src;
                audio.autoplay = true;
                audio.load();
            }
        }

        function AddMessageQueue(msgObj) {
            if (msgObj.queue.length == 0)
                return;
            if (engine == "google") {
                for (var i = 0; i < msgObj.queue.length; i++) {
                    msgarray.push(msgObj["queue"][i].url);
                }
                TriggerTTLPlay();
            } else if (engine = "togo") {
                var ssml = "";
                var msg = "";
                for (var i = 0; i < msgObj.queue.length; i++) {
                    if (msgObj["queue"][i].isAudio)
                        ssml += "<audio soundLevel=\"-8\" src=\"" + msgObj["queue"][i].url + "\">" + msgObj["queue"][i].msg + "</audio>";
                    else
                        ssml += msgObj["queue"][i].msg;
                    msg += msgObj["queue"][i].msg;
                }
                if (ssml == "") return;
                var lc = lanTest(msg);
                if (lc == "ja") lc = "ja-JP";
                if (lc == "zh_cn") lc = "cmn-TW";
                if (lc == "en_us") lc = "en-US";
                var md5hash = CryptoJS.MD5(ssml);
                var md5str = md5hash.toString();
                if (md5str in ttscache) {
                    audioQueue.push("data:audio/ogg;base64," + ttscache[md5str]);
                    TriggerTTLPlay();
                    return;
                }
                if (ttsremotecache.indexOf(md5str) >= 0) {
                    audioQueue.push("ttscache/" + md5str + ".ogg");
                    TriggerTTLPlay();
                    return;
                }
                $.ajax({
                    type: "post",
                    url: "https://texttospeech.googleapis.com/v1/text:synthesize?key=AIzaSyBtaFSBPJQncH9hxedjReKH8NMwgsvFvPc",
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({
                        input: {
                            ssml: "<speak>" + ssml + "</speak>"
                        },
                        voice: {
                            languageCode: lc,
                            ssmlGender: "FEMALE"
                        },
                        audioConfig: {
                            audioEncoding: "OGG_OPUS",
                            volumeGainDb: 0
                        }
                    }),
                    cache: false,
                    success: function (json) {
                        if (json.audioContent == "") return;
                        ttscache[md5str] = json.audioContent;
                        audioQueue.push("data:audio/ogg;base64," + json.audioContent);
                        TriggerTTLPlay();
                    }
                })
            }
        }

        function SimpleMessageToQueue(message) {
            var output = {
                isAllAudio: false,
                message: message,
                messageOutputSzie: message.length,
                messageLength: message.length,
                messageInSize: message,
                messageIsTooLong: false,
                messageIsNotFull: true,
                queue: [
                    {
                        msg: message,
                        url: "https://ttsproxy1.appspot.com/" + message + "?tl=" + lanTest(message) + "&engine=google&itriconf=TW_SPK_AKoan,0,0,0,5",
                    }
                ]
            };
            return output;
        }

        function ProcessMessageToQueue(message) {

            message = message.toLowerCase();

            var output = {
                isAllAudio: true,
                message: message,
                messageOutputSzie: 35,
                messageLength: 0,
                messageInSize: "",
                messageIsTooLong: false,
                messageIsNotFull: true,
                queue: [
                    {
                        msg: "",
                        url: ""
                    }
                ]
            };

            output["queue"] = [];

            for (var i = 0; i < output["message"].length; i++) {
                var spaceAt = output["message"].indexOf(' ', i);
                if (spaceAt < 0) {
                    spaceAt = output["message"].length;
                }
                var word = output["message"].substring(i, spaceAt);
                var thisWordLen = word.length;
                var wordLeng = lanTest(word);
                if (wordLeng == 'en_us') {
                    if (word >= 10) {
                        thisWordLen = 3;
                    } else if (word >= 5) {
                        thisWordLen = 2;
                    } else {
                        thisWordLen = 1;
                    }
                }

                if (output["messageIsNotFull"]) {
                    if (wordLeng == 'en_us') {
                        output["messageInSize"] += word + " ";
                    } else {
                        var leftSpace = output["messageOutputSzie"] - output["messageLength"];
                        if (thisWordLen > leftSpace) {
                            output["messageInSize"] += word.substring(0, leftSpace) + " ";
                        } else {
                            output["messageInSize"] += word;
                        }
                    }
                }

                output["messageLength"] += thisWordLen;
                if (output["messageLength"] >= output["messageOutputSzie"]) {
                    output["messageIsTooLong"] = true;
                    break;
                }
                i = spaceAt;
            }

            var processMessage = output["messageInSize"].trim();

            if (se == "on") {

                var processStar = 0;
                var stringBuffer = "";
                for (i = 0; i < processMessage.length; i++) {
                    var currentChar = processMessage.charAt(i);
                    if (!(currentChar in audioIndex))
                        continue;
                    if (!Array.isArray([currentChar]))
                        continue;

                    var isMatch = false;
                    var matchAudio = null;

                    for (j = 0; j < audioIndex[currentChar].length; j++) {
                        if (processMessage.indexOf(audioIndex[currentChar][j], i) == i) {
                            isMatch = true;
                            matchAudio = audioIndex[currentChar][j];
                            break;
                        }
                    }

                    if (!isMatch)
                        continue;

                    if (i - processStar > 0) {
                        var normalMessage = filter(processMessage.substring(processStar, i));
                        if (normalMessage != "") {
                            // msgarray.push("https://ttsproxy1.appspot.com/" + normalMessage + "?tl=" + lanTest(normalMessage) + "&engine=" + engine + "&itriconf=" + itriconfig);
                            output["queue"].push({
                                msg: normalMessage,
                                url: "https://ttsproxy1.appspot.com/" + normalMessage + "?tl=" + lanTest(normalMessage) + "&engine=google&itriconf=TW_SPK_AKoan,0,0,0,5",
                                isAudio: false
                            });
                            output["isAllAudio"] = false;
                        }
                    }

                    var audioMessage = getAudioFromLibrary(matchAudio);
                    if (audioMessage != null) {
                        // msgarray.push("https://togo01.github.io/twitch-bandu/audio/" + audioMessage);
                        output["queue"].push({
                            msg: matchAudio,
                            url: "https://togo01.github.io/twitch-bandu/audio/" + audioMessage,
                            isAudio: true
                        });
                        i += matchAudio.length - 1;
                        processStar = i + 1;
                    }

                }

                if (processStar >= processMessage.length)
                    return output;

                processMessage = processMessage.substring(processStar);

                var audioMsg = getAudioFromLibrary(processMessage);
                if (audioMsg != null) {
                    // msgarray.push("https://togo01.github.io/twitch-bandu/audio/" + audioMsg);
                    output["queue"].push({
                        msg: processMessage,
                        url: "https://togo01.github.io/twitch-bandu/audio/" + audioMsg,
                        isAudio: true
                    })
                    return output;
                }

            }

            var msg = filter(processMessage);
            if (msg != "") {
                // msgarray.push("https://ttsproxy1.appspot.com/" + msg + "?tl=" + lanTest(msg) + "&engine=google");
                output["queue"].push({
                    msg: msg,
                    url: "https://ttsproxy1.appspot.com/" + msg + "?tl=" + lanTest(msg) + "&engine=google&itriconf=TW_SPK_AKoan,0,0,0,5",
                    isAudio: false
                });
                output["isAllAudio"] = false;

                if (msg == "滾滾") {
                    // msgarray.push("https://togo01.github.io/twitch-bandu/audio/嘿右.mp3");
                    output["queue"].push({
                        msg: "嘿右",
                        url: "https://togo01.github.io/twitch-bandu/audio/嘿右.mp3",
                        isAudio: true
                    });
                } else if (output.messageIsTooLong) {
                    // msgarray.push("https://ttsproxy1.appspot.com/太長唸完會嘴酸?tl=zh_cn&engine=google");
                    output["queue"].push({
                        msg: "太長念完會嘴酸",
                        url: "https://ttsproxy1.appspot.com/太長唸完會嘴酸?tl=zh_cn&engine=google&itriconf=TW_SPK_AKoan,0,0,0,5",
                        isAudio: false
                    });
                }
            }

            return output;

        }

        function lanTest(msg) {
            var recht = /[\u4e00-\u9fa5]/;
            var rejp = /[\u3041-\u30fa]/;
            var pattern = /[\u3105-\u3129\u02CA\u02C7\u02CB\u02D9]/; //注音符號 Unicode 範圍
            var num = /[0-9]/;
            language = 'en_us';

            if (recht.test(msg) || pattern.test(msg) || num.test(msg)) {
                language = 'zh_cn';
            }
            if (rejp.test(msg)) {
                language = 'ja';
            }
            return language;
        }

        function filter(msg) {
            msg = msg.trim();

            for (i in filters) {
                if (filters[i].match instanceof RegExp) {
                    if (msg.match(filters[i].match) == null) continue;
                }
                msg = msg.replace(filters[i].regex, filters[i].replace);
                if (msg.length == 0)
                    return msg;
            }

            return msg;

        }

        window.onload = function () {

            reloadAudioList(true);
            reloadTTSRemoteCache();
            reloadFilter(true);
            reloadUsers();
            setInterval(checkAudioListVersion, 5000);

            audio = document.getElementById('maudio');
            audio.onended = function () {
                TriggerTTLPlay();
            }

            function getParameterByName(name, url) {
                if (!url) url = window.location.href;
                name = name.replace(/[\[\]]/g, '\\$&');
                var regex = new RegExp('[#?&]' + name + '(=([^&#]*)|&|#|$)'),
                    results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, ' '));
            }

            if (window.location.toString().indexOf("#") != -1 && window.location.toString().indexOf("channel=") != -1) {

                channel = getParameterByName('channel');
                engine = getParameterByName('engine');
                itriconfig = getParameterByName('itriconfig');
                volume = getParameterByName('volume');
                banlist = getParameterByName('banlist');
                se = getParameterByName('se');
                cdsec = getParameterByName('cdsec');

                $("#channel_textarea").val(channel);
                $("#banlist_textarea").val(banlist);
                $("#cdsec_textarea").val(cdsec);

                if (engine != "google" && engine != "togo") engine = "togo";

                if (engine == "togo") {

                    $("#enginelabel2").animate({
                        backgroundColor: "#FF0000",
                        color: "rgba(0, 0, 0, 0.5)"
                    }, 1000);
                    $("#enginelabel1").animate({
                        backgroundColor: "rgba(1,1,1,0)",
                        color: "rgba(255, 255, 255, 0.35)"
                    }, 1000);

                }

                if (se != "on" && se != "off") se = "on";

                if (se == "on") {

                    $("#sclabel1").animate({
                        backgroundColor: "#FF0000",
                        color: "rgba(0, 0, 0, 0.5)"
                    }, 1000);
                    $("#sclabel2").animate({
                        backgroundColor: "rgba(1,1,1,0)",
                        color: "rgba(255, 255, 255, 0.35)"
                    }, 1000);

                }

                var itriconfar = "TW_SPK_AKoan,0,0,0,5".split(',');
                jQuery("#ttsspeaker").val(itriconfar[0]);
                jQuery("#speed").val(itriconfar[1]);
                jQuery("#pitchlevel").val(itriconfar[2]);
                jQuery("#pitchsign").val(itriconfar[3]);
                jQuery("#pitchscale").val(itriconfar[4]);

                $("audio").prop("volume", volume);

                updateurl();

            } else {
                channel = "";
                engine = "google";
                itriconfig = "TW_SPK_AKoan,0,0,0,5";
                volume = 0.6;
                banlist = "nightbot";
                se = "on";
                cdsec = "25";
                $("#banlist_textarea").val("nightbot")
                $("#cdsec_textarea").val("25");
                $("audio").prop("volume", volume);
            }

            if (channel != null && channel != "") {
                connect();
            }
            $('#settingpage').show("slow");


            function updateurl() {

                if (window.location.toString().indexOf("access_token") != -1) {
                    document.location.href = window.location.toString().split("bearer")[0] + "bearer&channel=" + channel + "&engine=" + engine + "&volume=" + volume + "&banlist=" + banlist + "&se=" + se;
                } else {
                    document.location.href = "#&channel=" + channel + "&engine=" + engine + "&volume=" + volume + "&banlist=" + banlist + "&se=" + se;
                }
            }

            function CoolDown() {
                cd = true;
            }

            function connect() {
                bot = new twitchIRC(username, oauth, {
                    "channels": ["#" + channel],
                    "whispers": true
                });
                bot.on("message_with_tags", function (channel_f, user, message, tags) {

                    var messageWitoutEmoji = "";
                    var banlistsrray = banlist.split(",");
                    var emotrarr;
                    var emotrarr2 = [];
                    if (tags["emotes"]) {
                        var emotrarr = tags["emotes"].split("/");
                        for (var i in emotrarr) {
                            if (emotrarr.hasOwnProperty(i)) {
                                var emonum = emotrarr[i].split(":")[0];
                                var index = emotrarr[i].split(":")[1];
                                var indexarr = index.split(",")
                                for (var k in indexarr) {
                                    var index0 = indexarr[k].split("-")[0];
                                    var index1 = indexarr[k].split("-")[1];
                                    emotrarr2.push([index0, index1, emonum]);
                                }
                            }
                        }
                    }
                    var displaynamefix = tags["display-name"];
                    if (user.toLowerCase() == tags["display-name"].toLowerCase() || tags["display-name"] == "") {
                        displaynamefix = "";
                    }
                    var ircline = $("<div></div>").addClass('ircline');
                    var color = tags["color"];
                    if (color) {
                        var red = 255 - parseInt(color.substring(1, 3), 16);
                        var green = 255 - parseInt(color.substring(3, 5), 16);
                        var bule = 255 - parseInt(color.substring(5, 7), 16);
                        var colorrgb = "rgb(" + red + "," + green + "," + bule + ")"; //算出補色
                        var namespan = $('<span></span>').css("color", color).css("text-shadow", "-1px -1px 0 " + colorrgb + ", 1px -1px 0 " + colorrgb + ", -1px 1px 0 " + colorrgb + ", 1px 1px 0 " + colorrgb);
                    } else {
                        var namespan = $('<span></span>').css("color", "#FFFFFF").css("text-shadow", "-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000");
                    }
                    if (displaynamefix != "") {
                        var ruby = $('<ruby></ruby>').text(displaynamefix);
                        var rt = $('<rt></rt>').text(user);
                        ruby.append(rt);
                    } else {
                        var ruby = $('<ruby></ruby>').text(user);
                    }
                    var llspan = $('<span></span>').text(':');
                    var msgspan = $('<span></span>').addClass('message');
                    var afterstr = "";
                    for (var i = 0; i < message.length; i++) {
                        if (emotrarr2.length != 0) {
                            var haskappa = false;
                            for (var j in emotrarr2) {
                                if (emotrarr2[j][0] == i) {
                                    var img = "<img src=\"http://static-cdn.jtvnw.net/emoticons/v1/" + emotrarr2[j][2] + "/1.0\" />"
                                    afterstr += img;
                                    haskappa = true;
                                    i = i + (emotrarr2[j][1] - emotrarr2[j][0]);
                                }

                            }
                            if (!haskappa) {
                                afterstr += message.charAt(i);
                                messageWitoutEmoji += message.charAt(i);
                            }
                        } else {
                            afterstr += message.charAt(i);
                            messageWitoutEmoji += message.charAt(i);
                        }
                    }
                    msgspan.append(afterstr);
                    namespan.append(ruby);
                    ircline.append(namespan);
                    ircline.append(llspan);
                    ircline.append(msgspan);
                    if ($('.ircline').size() >= 30) {
                        $('.ircline').first().remove();
                    }
                    $("#chat_box").append(ircline.css("animation", "scrollclip 1s"));
                    $('#chat_box')[0].scrollTop = $('#chat_box')[0].scrollHeight;

                    if (banlistsrray.indexOf(user) == -1) {

                        var skipMessage = false;
                        if (users[user] == undefined || users[user] == null) {
                            users[user] = {
                                messages: [],
                                lastMessage: "",
                                lastMessageAt: 0,
                                hasSameMessageCount: 0,
                                banCount: 0
                            };
                        } else {
                            if (Date.now() - users[user].lastMessageAt < 8000) {
                                if (users[user].lastMessage == message || 
                                    users[user].lastMessage.indexOf(message) >= 0 || 
                                    message.indexOf(users[user].lastMessage) >= 0) 
                                {
                                    users[user].hasSameMessageCount++;
                                    if (users[user].hasSameMessageCount >= 2) {
                                        skipMessage = true;
                                    }
                                    if (users[user].hasSameMessageCount == 2) {
                                        if (valid_users[user] != undefined && valid_users[user] != null && valid_users[user] != "") {
                                            AddMessageQueue(ProcessMessageToQueue(valid_users[user] + " 不要再刷了拉"));
                                        } else {
                                            AddMessageQueue(ProcessMessageToQueue(displaynamefix + " 不要再刷了拉"));
                                        }
                                        users[user].banCount++;
                                    }
                                } else {
                                    users[user].hasSameMessageCount = 0;
                                    if (Date.now() - users[user].lastMessageAt < 1000) {
                                        skipMessage = true;
                                    }
                                }
                            } else {
                                users[user].hasSameMessageCount = 0;
                            }
                        }

                        var sayHello = (users[user].messages.length == 0) || (Date.now() - [user].lastMessageAt > 60 * 60 * 1000);

                        users[user].messages.push({ m: message, t: Date.now() });
                        users[user].lastMessage = message;
                        users[user].lastMessageAt = Date.now();

                        if (skipMessage) return;

                        messageWitoutEmoji = messageWitoutEmoji.trim();
                        messageWitoutEmoji = filter(messageWitoutEmoji);

                        var messageQueue = ProcessMessageToQueue(message);

                        if (!messageQueue.isAllAudio && messageWitoutEmoji.length > 0 && lanTest(messageWitoutEmoji) == "en_us") {
                            var translate = "";
                            if (messageWitoutEmoji in transcache) {
                                translate = transcache[messageWitoutEmoji];
                                messageQueue = ProcessMessageToQueue(translate);
                                messageQueue.queue.unshift({
                                    msg: "翻譯蒟蒻",
                                    url: "https://ttsproxy1.appspot.com/翻譯蒟蒻?tl=zh_cn&engine=google&itriconf=TW_SPK_AKoan,0,0,0,5",
                                    isAudio: false
                                });
                                if (sayHello) SayHelloTo(user, displaynamefix, "en_us");
                                AddMessageQueue(messageQueue);
                            } else {
                                $.ajax({
                                    type: "post",
                                    url: "https://translation.googleapis.com/language/translate/v2?key=AIzaSyAZ2ojMmYwZH79266LWN7EVHhsSV8HcYfI",
                                    dataType: "json",
                                    data: {
                                        q: messageWitoutEmoji,
                                        source: "en",
                                        target: "zh-TW",
                                        format: "text"
                                    },
                                    cache: false,
                                    success: function (json) {
                                        if ("data" in json) {
                                            if ("translations" in json["data"]) {
                                                if (Array.isArray(json["data"]["translations"]) && json["data"]["translations"].length > 0) {
                                                    translate = json["data"]["translations"][0]["translatedText"];
                                                }
                                            }
                                        }
                                    }
                                }).always(function () {
                                    if (translate != "" && lanTest(translate) != "en_us") {
                                        transcache[messageWitoutEmoji] = translate;
                                        messageQueue = ProcessMessageToQueue(translate);
                                        messageQueue.queue.unshift({
                                            msg: "翻譯蒟蒻",
                                            url: "https://ttsproxy1.appspot.com/翻譯蒟蒻?tl=zh_cn&engine=google&itriconf=TW_SPK_AKoan,0,0,0,5",
                                            isAudio: false
                                        });
                                    }
                                    if (sayHello) SayHelloTo(user, displaynamefix, "en_us");
                                    AddMessageQueue(messageQueue);
                                });
                            }
                        } else {
                            if (sayHello) SayHelloTo(user, displaynamefix, lanTest(message));
                            AddMessageQueue(messageQueue);
                        }


                    }
                });

                function SayHelloTo(user, displaynamefix, lang) {
                    var name = displaynamefix;
                    if (valid_users[user] != undefined && valid_users[user] != null && valid_users[user] != "") {
                        name = valid_users[user];
                    }
                    if (lang == "en_us") {
                        AddMessageQueue(ProcessMessageToQueue("Hello " + name));
                        return;
                    }
                    if (lang == "ja") {
                        AddMessageQueue(ProcessMessageToQueue("こんにちは" + name));
                        return;
                    }
                    AddMessageQueue(ProcessMessageToQueue(name + "安安"));
                }



                bot.on("join", function (channel_f, user) {
                    if (user == "justinfan12345") {
                        var txt2 = $("<div class=\"ircline\"></div>").text("成功登入" + channel_f);
                        $("#chat_box").append(txt2);
                        $("#chat_box")[0].scrollTop = $("#chat_box").prop("scrollHeight");
                    }
                });
                bot.on("part", function (channel_f, user) {
                    if (user == "justinfan12345") {
                        var txt2 = $("<div class=\"ircline\"></div>").text("成功登出" + channel_f);
                        $("#chat_box").append(txt2);
                        $("#chat_box")[0].scrollTop = $("#chat_box").prop("scrollHeight");
                    }
                });


            }

            $("body").bind('keypress', function (e) {
                if (e.keyCode == 13) {
                    $('#settingpage').toggle("slow");
                }
            });

            $("#channel_button").click(function () {
                if (bot == null) {
                    $("#channel_textarea").val($("#channel_textarea").val().toLowerCase());
                    channel = $("#channel_textarea").val();
                    updateurl();
                    connect();
                } else {
                    bot.part(channel);
                    $("#channel_textarea").val($("#channel_textarea").val().toLowerCase());
                    channel = $("#channel_textarea").val();
                    updateurl();
                    bot.join(channel);
                }

            });

            $("#banlist_button").click(function () {
                $("#banlist_textarea").val($("#banlist_textarea").val().toLowerCase());
                banlist = $("#banlist_textarea").val();
                updateurl();

            });

            $("#enginelabel1").click(function () {
                engine = "google";
                updateurl();

                $("#enginelabel1").animate({
                    backgroundColor: "#FF0000",
                    color: "rgba(0, 0, 0, 0.5)"
                }, 1000);
                $("#enginelabel2").animate({
                    backgroundColor: "rgba(1,1,1,0)",
                    color: "rgba(255, 255, 255, 0.35)"
                }, 1000);


            });

            $("#enginelabel2").click(function () {

                engine = "togo";
                updateurl();

                $("#enginelabel2").animate({
                    backgroundColor: "#FF0000",
                    color: "rgba(0, 0, 0, 0.5)"
                }, 1000);
                $("#enginelabel1").animate({
                    backgroundColor: "rgba(1,1,1,0)",
                    color: "rgba(255, 255, 255, 0.35)"
                }, 1000);

            });

            $("#sclabel1").click(function () {
                se = "on";
                updateurl();
                $("#sclabel1").animate({
                    backgroundColor: "#FF0000",
                    color: "rgba(0, 0, 0, 0.5)"
                }, 1000);
                $("#sclabel2").animate({
                    backgroundColor: "rgba(1,1,1,0)",
                    color: "rgba(255, 255, 255, 0.35)"
                }, 1000);
            });
            $("#sclabel2").click(function () {
                se = "off";
                updateurl();
                $("#sclabel2").animate({
                    backgroundColor: "#FF0000",
                    color: "rgba(0, 0, 0, 0.5)"
                }, 1000);
                $("#sclabel1").animate({
                    backgroundColor: "rgba(1,1,1,0)",
                    color: "rgba(255, 255, 255, 0.35)"
                }, 1000);

            });

            $("#cdsec_button").click(function () {

                cdsec = $("#cdsec_textarea").val();
                updateurl();

            });


            $("#ttsspeaker").change(function () {
                itrionchange();
            });
            $("#speed").change(function () {
                itrionchange();
            });
            $("#pitchlevel").change(function () {
                itrionchange();
            });
            $("#pitchsign").change(function () {
                itrionchange();
            });
            $("#pitchscale").change(function () {
                itrionchange();
            });

            function itrionchange() {
                itriconfig = jQuery("#ttsspeaker").val() + "," + jQuery("#speed").val() + "," + jQuery("#pitchlevel").val() + "," + jQuery("#pitchsign").val() + "," + jQuery("#pitchscale").val();
                updateurl();
            }

            // setInterval(speak_runnable, 100);

            // speak_runnable();

            // function speak_runnable() {
            //     if (isPlayingAudio) return;

            //     if (msgarray[0] && (audio.paused || audio.ended)) {
            //         isPlayingAudio = true;
            //         audio.src = msgarray[0];
            //         audio.autoplay = true;
            //         audio.load();
            //         msgarray.shift();
            //     }
            // }

            $("#slider").slider({
                min: 0,
                max: 100,
                step: 1,
                change: showValue
            });

            $("#slider").slider("value", volume * 100)

            function showValue(event, ui) {
                $("#volumetext").text("設定發音音量:" + ui.value / 100 + "　　　");
                volume = ui.value / 100;
                $("audio").prop("volume", volume);
                updateurl();
            }

        }
    </script>
</head>

<body>



    <div id=chat_box></div>

    <div id="settingpage"
        style="display:none;position: absolute; top: 50%; left: 50%; margin-top: -172px; margin-left: -365px; color: rgb(211, 211, 211); width: 730px; height: 345px; z-index: 9002; border-radius: 3px; border: 1px solid rgb(0, 0, 0); box-shadow: rgba(0, 0, 0, 0.298039) -1px 0px 0px, rgba(0, 0, 0, 0.2) -2px 0px 0px, rgba(0, 0, 0, 0.0980392) -3px 0px 0px, rgba(0, 0, 0, 0.298039) 1px 0px 0px, rgba(0, 0, 0, 0.2) 2px 0px 0px, rgba(0, 0, 0, 0.0980392) 3px 0px 0px, rgba(0, 0, 0, 0.298039) 0px -1px 0px, rgba(0, 0, 0, 0.2) 0px -2px 0px, rgba(0, 0, 0, 0.0980392) 0px -3px 0px, rgba(0, 0, 0, 0.298039) 0px 1px 0px, rgba(0, 0, 0, 0.2) 0px 2px 0px, rgba(0, 0, 0, 0.0980392) 0px 3px 0px; background-color: rgb(30, 30, 30);">
        <div
            style="border-top-left-radius: 3px; border-top-right-radius: 3px; width: 100%; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(17, 17, 17); display: block; height: 45px; background-color: rgb(40, 40, 40);">
            <span class="closebutton"
                onclick="javascript:(function(){   $('#settingpage').toggle(&quot;slow&quot;);   })();"
                onmouseover="javascript:(function(){    jQuery( &quot;.closebutton&quot; ).animate({opacity: 0.5}, 500, function() { });   })();"
                onmouseout="javascript:(function(){    jQuery( &quot;.closebutton&quot;  ).animate({opacity: 0.2}, 500, function() { });   })();"
                style="font-size: 39px; float: right; right: 20px; top: 0px; position: absolute; color: rgb(255, 255, 255); text-shadow: rgb(0, 0, 0) 0px 1px 0px; opacity: 0.2; display: block;">×</span>
        </div>
        <div class="scroll" style="overflow-y: scroll; height: 300px;">
            <div>
                <div class="option">
                    <span
                        style="color: rgb(211, 211, 211); font-family: &quot;Microsoft JhengHei&quot;; font-size: 16px;">設定頻道(twitch帳號)</span>
                    <textarea id="channel_textarea" wrap="wrap"
                        style="color: rgb(211, 211, 211); position: absolute; float: right; right: 65px; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: &quot;Microsoft JhengHei&quot;; box-shadow: none; width: 250px !important; height: 22px !important; border: 1px solid rgb(51, 51, 51) !important; background-color: rgb(20, 20, 20) !important;"></textarea>
                    <button id="channel_button"
                        style="color: rgb(211, 211, 211); position: absolute; float: right; right: 7px; width: 50px !important; height: 28px !important; border: 1px solid rgb(51, 51, 51) !important; background-color: rgb(20, 20, 20) !important;">ok</button>
                </div>
                <div class="option" style="background-color: rgb(35, 35, 35);">
                    <span id="volumetext"
                        style="color: rgb(211, 211, 211); font-family: &quot;Microsoft JhengHei&quot;; font-size: 16px;">設定發音音量:0.6　　　</span>
                    <span id="slider"
                        style="background-color: rgb(35, 35, 35);width:500px;display:inline-block; top:3px "><span>
                </div>
                <div class="option">
                    <span id="banlisttext"
                        style="color: rgb(211, 211, 211); font-family: &quot;Microsoft JhengHei&quot;; font-size: 16px;">禁止發音名單　　ーーー多個用逗點隔開</span>
                    <textarea id="banlist_textarea" wrap="wrap"
                        style="color: rgb(211, 211, 211); position: absolute; float: right; right: 65px; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: &quot;Microsoft JhengHei&quot;; box-shadow: none; width: 250px !important; height: 22px !important; border: 1px solid rgb(51, 51, 51) !important; background-color: rgb(20, 20, 20) !important;"></textarea>
                    <button id="banlist_button"
                        style="color: rgb(211, 211, 211); position: absolute; float: right; right: 7px; width: 50px !important; height: 28px !important; border: 1px solid rgb(51, 51, 51) !important; background-color: rgb(20, 20, 20) !important;">ok</button>


                </div>

                <div class="option" style="background-color: rgb(35, 35, 35);">
                    <span
                        style="color: rgb(211, 211, 211); font-family: &quot;Microsoft JhengHei&quot;; font-size: 16px;">合成語音引擎</span>
                    <div
                        style="position: relative; float: right; top: 1px; right: 7px; height: 26px; width: 120px; border-radius: 3px; background: rgba(0, 0, 0, 0.247059);">
                        <label id="enginelabel1" class="switch-label"
                            style="color: rgba(0, 0, 0, 0.498039); background-color: rgba(255, 0, 0,1);">Google</label>
                        <label id="enginelabel2" class="switch-label">Togo</label>
                    </div>
                </div>

                <div class="option" style="display: none;">
                    <span
                        style="color: rgb(211, 211, 211); font-family: &quot;Microsoft JhengHei&quot;; font-size: 16px;">工研院小姐設定</span>
                    <span id="msellist"
                        style="font-size: 15px; text-align: center; color: rgb(211, 211, 211); width: 555px; height: 26px; position: absolute; float: right; right: 20px; box-shadow: none; z-index: 1; border: 1px solid rgb(51, 51, 51) !important; background-color: rgb(20, 20, 20) !important;">
                        語者 <select id="ttsspeaker" name="ttsspeaker">
                            <option value="Bruce">Bruce</option>
                            <option value="Theresa">Theresa</option>
                            <option value="Angela">Angela</option>
                            <option value="MCHEN_Bruce">MCHEN_Bruce</option>
                            <option value="MCHEN_Joddess">MCHEN_Joddess</option>
                            <option value="ENG_Bob">ENG_Bob</option>
                            <option value="ENG_Alice">ENG_Alice</option>
                            <option value="ENG_Tracy">ENG_Tracy</option>
                            <option value="TW_LIT_AKoan">TW_LIT_AKoan</option>
                            <option value="TW_SPK_AKoan" selected="">TW_SPK_AKoan</option>
                        </select>
                        速度 <select id="speed" name="speed">
                            <option value="10">10</option>
                            <option value="9">9</option>
                            <option value="8">8</option>
                            <option value="7">7</option>
                            <option value="6">6</option>
                            <option value="5">5</option>
                            <option value="4">4</option>
                            <option value="3">3</option>
                            <option value="2">2</option>
                            <option value="1">1</option>
                            <option value="0" selected="">0</option>
                            <option value="-1">-1</option>
                            <option value="-2">-2</option>
                            <option value="-3">-3</option>
                            <option value="-4">-4</option>
                            <option value="-5">-5</option>
                            <option value="-6">-6</option>
                            <option value="-7">-7</option>
                            <option value="-8">-8</option>
                            <option value="-9">-9</option>
                            <option value="-10">-10</option>
                        </select>
                        音高 <select id="pitchlevel" name="pitchlevel">
                            <option value="10">10</option>
                            <option value="9">9</option>
                            <option value="8">8</option>
                            <option value="7">7</option>
                            <option value="6">6</option>
                            <option value="5">5</option>
                            <option value="4">4</option>
                            <option value="3">3</option>
                            <option value="2">2</option>
                            <option value="1">1</option>
                            <option value="0" selected="">0</option>
                            <option value="-1">-1</option>
                            <option value="-2">-2</option>
                            <option value="-3">-3</option>
                            <option value="-4">-4</option>
                            <option value="-5">-5</option>
                            <option value="-6">-6</option>
                            <option value="-7">-7</option>
                            <option value="-8">-8</option>
                            <option value="-9">-9</option>
                            <option value="-10">-10</option>
                        </select>
                        說話方式 <select id="pitchsign" name="pitchsign">
                            <option value="0" selected="">正常</option>
                            <option value="1">機器人</option>
                            <option value="2">外國人</option>
                        </select>
                        抑揚頓挫 <select id="pitchscale" name="pitchscale">
                            <option value="20">20</option>
                            <option value="19">19</option>
                            <option value="18">18</option>
                            <option value="17">17</option>
                            <option value="16">16</option>
                            <option value="15">15</option>
                            <option value="14">14</option>
                            <option value="13">13</option>
                            <option value="12">12</option>
                            <option value="11">11</option>
                            <option value="10">10</option>
                            <option value="9">9</option>
                            <option value="8">8</option>
                            <option value="7">7</option>
                            <option value="6">6</option>
                            <option value="5" selected="">5</option>
                            <option value="4">4</option>
                            <option value="3">3</option>
                            <option value="2">2</option>
                            <option value="1">1</option>
                            <option value="0">0</option>
                        </select>
                    </span>
                </div>

                <div class="option" style="display: none; background-color: rgb(35, 35, 35);">
                    <span
                        style="color: rgb(211, 211, 211); font-family: &quot;Microsoft JhengHei&quot;; font-size: 16px;">滾滾語音</span>
                    <div
                        style="position: relative; float: right; top: 1px; right: 7px; height: 26px; width: 120px; border-radius: 3px; background: rgba(0, 0, 0, 0.247059);">
                        <label id="sclabel1" class="switch-label">開</label>
                        <label id="sclabel2" class="switch-label"
                            style="color: rgba(0, 0, 0, 0.498039); background-color: rgba(255, 0, 0,1);">關</label>
                    </div>
                </div>
                <div class="option" style="display: none;">
                    <span
                        style="color: rgb(211, 211, 211); font-family: &quot;Microsoft JhengHei&quot;; font-size: 16px;">特殊語音CD秒數</span>
                    <textarea id="cdsec_textarea" wrap="wrap"
                        style="color: rgb(211, 211, 211); position: absolute; float: right; right: 65px; font-style: normal; font-variant: normal; font-weight: normal; font-stretch: normal; font-size: 16px; line-height: normal; font-family: &quot;Microsoft JhengHei&quot;; box-shadow: none; width: 250px !important; height: 22px !important; border: 1px solid rgb(51, 51, 51) !important; background-color: rgb(20, 20, 20) !important;"></textarea>
                    <button id="cdsec_button"
                        style="color: rgb(211, 211, 211); position: absolute; float: right; right: 7px; width: 50px !important; height: 28px !important; border: 1px solid rgb(51, 51, 51) !important; background-color: rgb(20, 20, 20) !important;">ok</button>
                </div>
                <div class="option" 　style="background-color: rgb(35, 35, 35);">
                    <audio controls id="maudio"></audio>
                </div>
            </div>
        </div>

    </div>


</body>

</html>